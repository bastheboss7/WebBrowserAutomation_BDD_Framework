name: BDD Test Automation

on:
  workflow_dispatch:
    inputs:
      BROWSER:
        description: 'Pick a browser'
        required: true
        default: 'chrome'
        type: choice
        options: [chrome, firefox, edge]
      ENVIRONMENT:
        description: 'Target Environment'
        required: true
        default: 'QA'
        type: choice
        options: [QA, UAT, PROD]
      TAGS:
        description: 'Cucumber tags'
        required: true
        default: '@ParcelDelivery'
        type: choice
        options: ['@ParcelDelivery', '@ProhibitedItems', '@ParcelShopFilter']

  schedule:
    - cron: '0 2 * * *'

# Recommended: This confirms the write-access needed for GitHub Pages
permissions:
  contents: write

jobs:
  automation-suite:
    runs-on: ubuntu-latest
    container:
      image: markhobson/maven-chrome:jdk-21
      options: --user root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Maven Tests
        run: |
          mvn clean verify \
          -Dbrowser=${{ github.event.inputs.BROWSER || 'chrome' }} \
          -Denv=${{ github.event.inputs.ENVIRONMENT || 'PROD' }} \
          -Dcucumber.filter.tags="${{ github.event.inputs.TAGS || '@ParcelDelivery' }}"
          
      - name: Archive Reports (Backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Reports
          path: target/reports/

      - name: Prepare Report for Deployment
        if: always()
        run: |
          mkdir -p public
          cp -r target/reports/cucumber-report/cucumber-html-reports/* public/
          cp public/overview-features.html public/index.html

      - name: Deploy to Live Website
        if: always()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: public
          branch: gh-pages